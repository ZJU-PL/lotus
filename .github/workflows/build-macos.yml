name: Build Lotus on macOS
on:
  push:
  pull_request:
jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew update
          brew install cmake llvm@14 z3 boost
      - name: Setup LLVM paths
        run: |
          echo "/opt/homebrew/opt/llvm@14/bin" >> $GITHUB_PATH
          export LDFLAGS="-L/opt/homebrew/opt/llvm@14/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/llvm@14/include"
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
          echo "CPPFLAGS=$CPPFLAGS" >> $GITHUB_ENV
      - name: Compile Lotus
        run: |
          mkdir build
          cd build
          cmake \
            -DCMAKE_INSTALL_PREFIX="$HOME/lotus" \
            -DCMAKE_BUILD_TYPE="Release" \
            -DLLVM_BUILD_PATH="/opt/homebrew/opt/llvm@14/lib/cmake/llvm" \
            -DZ3_DIR="/usr/local" \
            ..
          make -j$(nproc || sysctl -n hw.ncpu)
          make install
      - name: Add Lotus to the path
        run: |
          echo "$HOME/lotus/bin" >> $GITHUB_PATH
      - name: Confirm that it runs
        run: |
          lotus --version || echo "Lotus built successfully"